openapi: 3.0.3
info:
  title: IDPAY ITN AB ASSISTANCE API
  version: 1.0.0
  description: IDPAY ITN AB ASSISTANCE API
  contact:
    name: CSTAR
    email: cstar@pagopa.it

servers:
  - description: Test/Sviluppo
    url: https://api.dev.cstar.pagopa.it/idpay-itn/ab/assistance
    x-internal: true
  - description: User Acceptance Test
    url: https://api.uat.cstar.pagopa.it/idpay-itn/ab/assistance
    x-internal: true
  - description: Produzione
    url: https://api.cstar.pagopa.it/idpay-itn/ab/assistance
    x-internal: false

tags:
  - name: service
    description: Operazione per l'assistenza

paths:
  /onboardings/status:
    post:
      operationId: getOnboardingStatus
      description: |
        Restituisce le informazioni su una richiesta di adesione conoscendo il
        codice fiscale del beneficiario
      tags: [service]
      security:
        - apiKeyAuth: []
      parameters:
        - $ref: '#/components/parameters/Ocp-Apim-Subscription-Key'
      requestBody:
        $ref: '#/components/requestBodies/GetStatus'
      responses:
        "200":
          #description: Ok
          $ref: '#/components/responses/OnboardingStatus'
        "400":
          #description: Bad request
          $ref: '#/components/responses/Error'
        "401":
          #description: Wrong credentials
          $ref: '#/components/responses/Error401'
        "403":
          #description: Forbidden
          $ref: '#/components/responses/Error'
        "404":
          #description: Not found
          $ref: '#/components/responses/Error'
        "406":
          #description: Not acceptable. Did you require application/json?
          $ref: '#/components/responses/Error'
        "415":
          #description: Unsupported media type. Did you provide application/json?
          $ref: '#/components/responses/Error'
        "429":
          #description: Too many request
          $ref: '#/components/responses/Error'
        "500":
          #description: Server error
          $ref: '#/components/responses/Error'
        default:
          #description: Unexpected error
          $ref: '#/components/responses/Error'

  /vouchers/status:
    post:
      operationId: getVoucherStatus
      description: |
        Restituisce le informazioni su voucher conoscendo il codice fiscale del
        beneficiario
      tags: [service]
      security:
        - apiKeyAuth: []
      parameters:
        - $ref: '#/components/parameters/Ocp-Apim-Subscription-Key'
      requestBody:
        $ref: '#/components/requestBodies/GetStatus'
      responses:
        "200":
          #description: Ok
          $ref: '#/components/responses/VoucherStatus'
        "400":
          #description: Bad request
          $ref: '#/components/responses/Error'
        "401":
          #description: Wrong credentials
          $ref: '#/components/responses/Error401'
        "403":
          #description: Forbidden
          $ref: '#/components/responses/Error'
        "404":
          #description: Not found
          $ref: '#/components/responses/Error'
        "406":
          #description: Not acceptable. Did you require application/json?
          $ref: '#/components/responses/Error'
        "415":
          #description: Unsupported media type. Did you provide application/json?
          $ref: '#/components/responses/Error'
        "429":
          #description: Too many request
          $ref: '#/components/responses/Error'
        "500":
          #description: Server error
          $ref: '#/components/responses/Error'
        default:
          #description: Unexpected error
          $ref: '#/components/responses/Error'

components:
  # ============================================================================
  # Schemas
  # ============================================================================
  schemas:
    # --------------------------------------------------------------------------
    # Technical types
    # --------------------------------------------------------------------------
    AccessControlAllowOrigin:
      description: |
        Indicates whether the response can be shared with requesting code from
        the given origin
      type: string
      pattern: "^[ -~]{1,2048}$"
      minLength: 1
      maxLength: 2048

    RateLimitLimit:
      description: The number of allowed requests in the current period
      type: integer
      format: int32
      minimum: 1
      maximum: 240

    RateLimitReset:
      description: The number of seconds left in the current period
      type: integer
      format: int32
      minimum: 1
      maximum: 60

    RetryAfter:
      description: |
        The number of seconds to wait before allowing a follow-up request
      type: integer
      format: int32
      minimum: 1
      maximum: 240

    # --------------------------------------------------------------------------
    # Basic types
    # --------------------------------------------------------------------------
    Channel:
      description: Canale
      enum:
        - IO
        - WEB
      type: string
      example: "IO"

    DateOfBirth:
      description: Data di nascita del beneficiario
      type: string
      format: date
      pattern: "^\\d{4}-\\d{2}-\\d{2}$"
      minLength: 10
      maxLength: 10
      example: "1985-12-10"

    DateOfOnboardingRequest:
      description: Data di richiesta dell'adesione
      type: string
      format: date
      pattern: "^\\d{4}-\\d{2}-\\d{2}$"
      minLength: 10
      maxLength: 10
      example: "2025-12-19"

    DateOfOnboardingOk:
      description: Data di avvenuto onboarding
      type: string
      format: date
      pattern: "^\\d{4}-\\d{2}-\\d{2}$"
      minLength: 10
      maxLength: 10
      example: "2025-12-19"


    Email:
      description: E-mail del beneficiario
      type: string
      pattern: "^[\\w-\\.]+@([\\w-]+\\.)+[\\w-]{2,4}$"
      minLength: 6
      maxLength: 256
      example: "mario.rossi@miaemail.it"

    ErrorCode:
      description: Codice d'errore
      type: string
      pattern: "^[A-F0-9]{9}$"
      minLength: 9
      maxLength: 9
      example: "999999999"

    ErrorDescription:
      description: Descrizione dell'errore
      type: string
      pattern: "^[ -~]{0,256}$"
      minLength: 0
      maxLength: 256
      example: "Error description"

    ExpirationDate:
      description: Data di scadenza del voucher
      type: string
      format: date
      pattern: "^\\d{4}-\\d{2}-\\d{2}$"
      minLength: 10
      maxLength: 10
      example: "2025-12-31"

    FiscalCode:
      description: Codice fiscale del beneficiario
      type: string
      pattern: "^(([A-Z]{6}\\d{2}[A-Z]\\d{2}[A-Z]\\d{3}[A-Z])|(\\d{11}))$"
      minLength: 11
      maxLength: 16
      example: "RSSMRA85T10A562S"

    IseeOptionSelected:
      description: Opzione ISEE selezionata dal beneficiario
      enum:
        - BELOW
        - ABOVE
        - UNAVAILABLE
      type: string
      example: "BELOW"

    IssueDate:
      description: Data di emissione del voucher
      type: string
      format: date
      pattern: "^\\d{4}-\\d{2}-\\d{2}$"
      minLength: 10
      maxLength: 10
      example: "2025-12-20"

    MaxDiscountAmount:
      description: Importo massimo dello sconto applicabile in centesimi di euro
      type: integer
      format: int32
      minimum: 10000
      maximum: 20000
      example: 10000

    Name:
      description: Nome del beneficiario
      type: string
      pattern: "^[ -~]{1,256}$"
      minLength: 1
      maxLength: 256
      example: "Mario"

    DetailKO:
      description: Dettaglio del KO del onboarding
      type: string
      pattern: "^[ -~]{1,256}$"
      minLength: 1
      maxLength: 256
      example: "Mario"

    OnboardingStatus:
      description: Stato della richiesta di adesione
      enum:
        - ONBOARDING_KO
        - ONBOARDING_OK
        - ON_EVALUATION
        - UNSUBSCRIBED
        - JOINED
      type: string
      example: "UNDER_EVALUATION"

    Surname:
      description: Cognome del beneficiario
      type: string
      pattern: "^[ -~]{1,256}$"
      minLength: 1
      maxLength: 256
      example: "Rossi"

    VoucherStatus:
      description: Stato del voucher
      enum:
        - USED,
        - EXPIRED,
        - ACTIVE,
        - EXPIRING
      type: string
      example: "SPENT"

    DateOfUse:
      description: |
        Data di utilizzo del voucher se il suo stato è SPENT, PREAUTHORIZED o
        REVERSED
      type: string
      format: date
      pattern: "^\\d{4}-\\d{2}-\\d{2}$"
      minLength: 10
      maxLength: 10
      example: "2025-12-25"

    AmountUsed:
      description: |
        Importo utilizzato del voucher in centesimi di euro se il suo stato è
        SPENT, PREAUTHORIZED o REVERSED
      type: integer
      format: int32
      minimum: 0
      maximum: 20000
      example: 5400

    TypeOfStore:
      description: |
        Tipologia di negozio in cui è stato utilizzato il voucher se il suo
        stato è SPENT, PREAUTHORIZED o REVERSED
      enum:
        - PHYSICAL
        - ONLINE
      type: string
      example: "PHYSICAL"

    Merchant:
      description: |
        Nome del negozio in cui è stato utilizzato il voucher se il suo stato è
        SPENT, PREAUTHORIZED o REVERSED
      type: string
      pattern: "^[ -~]{1,2048}$"
      minLength: 1
      maxLength: 2048
      example: "Elettrodomestici SRL"

    MerchantAddress:
      description: |
        Indirizzo del negozio in cui è stato utilizzato il voucher se il suo
        stato è SPENT, PREAUTHORIZED o REVERSED e se il tipo di negozio è
        PHYSICAL
      type: string
      pattern: "^[ -~]{1,2048}$"
      minLength: 1
      maxLength: 2048
      example: "Via Roma 10, 00100 Roma RM"

    MerchantCity:
      description: |
        Città del negozio in cui è stato utilizzato il voucher se il suo stato è
        SPENT, PREAUTHORIZED o REVERSED e se il tipo di negozio è PHYSICAL
      type: string
      pattern: "^[ -~]{1,256}$"
      minLength: 1
      maxLength: 256
      example: "Roma"

    PhoneNumber:
      description: |
        Numero di telefono del negozio in cui è stato utilizzato il voucher se
        il suo stato è SPENT, PREAUTHORIZED o REVERSED e se il tipo di negozio è
        PHYSICAL
      type: string
      pattern: "^[ -~]{0,20}$"
      minLength: 0
      maxLength: 20
      example: "+390612345678"

    GoodAmount:
      description: |
        Importo del bene acquistato con il voucher in centesimi di euro
      type: integer
      format: int32
      minimum: 0
      maximum: 2147483647
      example: 18000

    GoodDescription:
      description: Descrizione del bene acquistato con il voucher
      type: string
      pattern: "^[ -~]{1,2048}$"
      minLength: 1
      maxLength: 2048
      example: "Lavatrice modello XY1234"

    # --------------------------------------------------------------------------
    # Complex type for error handling.
    # --------------------------------------------------------------------------
    Error:
      description: Error details.
      type: object
      additionalProperties: false
      properties:
        code:
          $ref: '#/components/schemas/ErrorCode'
        description:
          $ref: '#/components/schemas/ErrorDescription'
      required:
        - code
        - description
      example:
        code: "999999999"
        description: "Error description"

    Error401:
      description: Error details.
      type: object
      additionalProperties: false
      properties:
        statusCode:
          $ref: '#/components/schemas/ErrorCode'
        message:
          $ref: '#/components/schemas/ErrorDescription'
      required:
        - statusCode
        - message
      example:
        statusCode: "401"
        message: "Error description"

    Errors:
      description: List of errors.
      type: object
      additionalProperties: false
      properties:
        errors:
          type: array
          minItems: 1
          maxItems: 32
          items:
            $ref: '#/components/schemas/Error'
      required:
        - errors
      example:
        errors:
          - code: "999999999"
            description: "Error description"

    # --------------------------------------------------------------------------
    # Complex types
    # --------------------------------------------------------------------------
    GetStatus:
      description: Dati di input della richiesta di stato
      type: object
      additionalProperties: false
      properties:
        fiscalCode:
          $ref: '#/components/schemas/FiscalCode'
      required:
        - fiscalCode
      example:
        fiscalCode: "RSSMRA85T10A562S"

    OnboardingStatusData:
      description: Informazioni di una richiesta di adesione
      additionalProperties: false
      properties:
        detailKO:
          $ref: '#/components/schemas/DetailKO'
        name:
          $ref: '#/components/schemas/Name'
        surname:
          $ref: '#/components/schemas/Surname'
        dateOfOnboardingRequest:
          $ref: '#/components/schemas/DateOfOnboardingRequest'
        dateOfOnboardingOk:
          $ref: '#/components/schemas/DateOfOnboardingOk'
        channel:
          $ref: '#/components/schemas/Channel'
        email:
          $ref: '#/components/schemas/Email'
        status:
          $ref: '#/components/schemas/OnboardingStatus'
      required:
        - dateOfOnboardingRequest
        - channel
        - status
      example:
        name: "Mario"
        surname: "Rossi"
        dateOfOnboardingRequest: "2025-12-19"
        channel: "IO"
        email: "mario.rossi@miaemail.it"
        status: "100_APPROVED"

    ReducedOperation:
      type: object
      properties:
        operationId:
          type: string
        operationType:
          type: string
        amountCents:
          type: integer
          format: int64
        operationDate:
          type: string
          format: date-time
        businessName:
          type: string

    ReducedTransaction:
      type: object
      properties:
        id:
          type: string
        trxDate:
          type: string
          format: date-time
        amountCents:
          type: integer
          format: int64
        merchantId:
          type: string
        pointOfSaleId:
          type: string
        additionalProperties:
          type: object
          properties:
            productGtin:
              type: string
            productName:
              type: string


    VoucherStatusData:
      type: object
      description: Informazioni di un voucher
      additionalProperties: false
      properties:
        name:
          type: string
          description: Nome del beneficiario
        surname:
          type: string
          description: Cognome del beneficiario
        issueDate:
          type: string
          format: date-time
          description: Data di emissione del voucher
        expirationDate:
          type: string
          format: date-time
          description: Data di scadenza del voucher
        status:
          type: string
          description: Stato del voucher (es. USED, ACTIVE)
        operations:
          type: array
          items:
            $ref: '#/components/schemas/ReducedOperation'
        transactions:
          type: array
          items:
            $ref: '#/components/schemas/ReducedTransaction'
      required:
        - issueDate
        - expirationDate
        - status
      example:
        name: "Mario"
        surname: "Rossi"
        issueDate: "2025-12-20T00:00:00"
        expirationDate: "2025-12-31T00:00:00"
        status: "USED"
        operations:
          - operationId: "OP12345"
            operationType: "TRANSACTION"
            amountCents: 5400
            operationDate: "2025-12-25T10:30:00"
            businessName: "Elettrodomestici SRL"
        transactions:
          - id: "TRX98765"
            trxDate: "2025-12-25T10:30:00"
            amountCents: 18000
            merchantId: "MERCHANT123"
            pointOfSaleId: "POS456"
            additionalProperties:
              - productGtin: "fridge004"
                productName: "Frigorifero Liebherr CBNasd 575i_091618851 362 l"


  # ============================================================================
  # Request bodies
  # ============================================================================
  requestBodies:
    GetStatus:
      description: Richiesta per le informazioni su una richiesta di adesione
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/GetStatus'

  # ============================================================================
  # Parameters
  # ============================================================================
  parameters:
    Ocp-Apim-Subscription-Key:
      name: Ocp-Apim-Subscription-Key
      in: header
      required: true
      schema:
        type: string

    RequestId:
      name: RequestId
      in: header
      description: Request Id that will be logged by services
      required: false
      schema:
        type: string
        format: uuid
        pattern: "^[a-fA-F0-9]{8}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{4}-[a-fA-F0-9]{12}$"
        minLength: 36
        maxLength: 36
        example: "d0d654e6-97da-4848-b568-99fedccb642b"

    Version:
      name: Version
      in: header
      description: Version of the required API
      required: false
      schema:
        type: string
        pattern: "^[ -~]{1,64}$"
        minLength: 1
        maxLength: 64
        example: "1.0.0-alpha-a.b-c-somethinglong+build.1-aef.1-its-okay"

  # ============================================================================
  # Responses
  # ============================================================================
  responses:
    OnboardingStatus:
      description: Risposta con le informazioni su una richiesta di adesione
      headers:
        Access-Control-Allow-Origin:
          description: |
            Indicates whether the response can be shared with requesting code
            from the given origin.
          required: false
          schema:
            $ref: '#/components/schemas/AccessControlAllowOrigin'
        RateLimit-Limit:
          description: The number of allowed requests in the current period.
          required: false
          schema:
            $ref: '#/components/schemas/RateLimitLimit'
        RateLimit-Reset:
          description: The number of seconds left in the current period
          required: false
          schema:
            $ref: '#/components/schemas/RateLimitReset'
        Retry-After:
          description: |
            The number of seconds to wait before allowing a follow-up request.
          required: false
          schema:
            $ref: '#/components/schemas/RetryAfter'
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/OnboardingStatusData'

    VoucherStatus:
      description: Risposta con le informazioni su un voucher
      headers:
        Access-Control-Allow-Origin:
          description: |
            Indicates whether the response can be shared with requesting code
            from the given origin.
          required: false
          schema:
            $ref: '#/components/schemas/AccessControlAllowOrigin'
        RateLimit-Limit:
          description: The number of allowed requests in the current period.
          required: false
          schema:
            $ref: '#/components/schemas/RateLimitLimit'
        RateLimit-Reset:
          description: The number of seconds left in the current period
          required: false
          schema:
            $ref: '#/components/schemas/RateLimitReset'
        Retry-After:
          description: |
            The number of seconds to wait before allowing a follow-up request.
          required: false
          schema:
            $ref: '#/components/schemas/RetryAfter'
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/VoucherStatusData'

    Error:
      description: Risposta d'errore
      headers:
        Access-Control-Allow-Origin:
          description: |
            Indicates whether the response can be shared with requesting code
            from the given origin.
          required: false
          schema:
            $ref: '#/components/schemas/AccessControlAllowOrigin'
        RateLimit-Limit:
          description: The number of allowed requests in the current period.
          required: false
          schema:
            $ref: '#/components/schemas/RateLimitLimit'
        RateLimit-Reset:
          description: The number of seconds left in the current period
          required: false
          schema:
            $ref: '#/components/schemas/RateLimitReset'
        Retry-After:
          description: |
            The number of seconds to wait before allowing a follow-up request.
          required: false
          schema:
            $ref: '#/components/schemas/RetryAfter'
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
        text/*:
          schema:
            type: string
            pattern: "^[ -~]{0,65535}$"
            minLength: 0
            maxLength: 65535

    Error401:
      description: Risposta d'errore 401
      headers:
        Access-Control-Allow-Origin:
          description: |
            Indicates whether the response can be shared with requesting code
            from the given origin.
          required: false
          schema:
            $ref: '#/components/schemas/AccessControlAllowOrigin'
        RateLimit-Limit:
          description: The number of allowed requests in the current period.
          required: false
          schema:
            $ref: '#/components/schemas/RateLimitLimit'
        RateLimit-Reset:
          description: The number of seconds left in the current period
          required: false
          schema:
            $ref: '#/components/schemas/RateLimitReset'
        Retry-After:
          description: |
            The number of seconds to wait before allowing a follow-up request.
          required: false
          schema:
            $ref: '#/components/schemas/RetryAfter'
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error401'
        text/*:
          schema:
            type: string
            pattern: "^[ -~]{0,65535}$"
            minLength: 0
            maxLength: 65535

  # ============================================================================
  # Security schemes
  # ============================================================================
  securitySchemes:
    apiKeyAuth:
      description: API key per l'autorizzazione
      type: apiKey
      in: header
