<!--
    MOCK Policy for SEND (RTP Request To Pay)

    Gestisce tre scenari di risposta:
    1. 201 body vuoto (default) → presuppone callback successiva → RTP status: SENT
    2. 201 body sincrono con fiscalCode QBICLE31R41A110G → RTP status: ACCEPTED
    3. 400 con fiscalCode LSSUDV05L25B272V → RTP status: REJECTED

    Il fiscalCode si trova nel JSON body nella struttura: payer.payerId
-->
<policies>
  <inbound>
    <base/>
    <choose>
      <!-- Case 1: Rejected scenario - fiscalCode: LSSUDV05L25B272V -->
      <when condition="@(context.Request.Body.As&lt;string&gt;(preserveContent: true).Contains(&quot;LSSUDV05L25B272V&quot;))">
        <return-response>
          <set-status code="400" reason="Bad Request"/>
          <set-header name="Content-Type" exists-action="override">
            <value>application/json</value>
          </set-header>
          <set-body>@{
  "error": "Debtor's fiscal code is not activated",
  "details": "The debtor's fiscal code provided is not activated by the subject making the request."
}</set-body>
        </return-response>
      </when>
      <!-- Case 2: Accepted scenario - fiscalCode: QBICLE31R41A110G -->
      <when condition="@(context.Request.Body.As&lt;string&gt;(preserveContent: true).Contains(&quot;QBICLE31R41A110G&quot;))">
        <return-response>
          <set-status code="201" reason="Created"/>
          <set-header name="Content-Type" exists-action="override">
            <value>application/json</value>
          </set-header>
          <set-header name="Location" exists-action="override">
            <value>https://domain.com/rtps/3fa85f64-5717-4562-b3fc-2c963f66afa6</value>
          </set-header>
          <set-body>@{
  "resourceID": "3fa85f64-5717-4562-b3fc-2c963f66afa6",
  "noticeNumber": "311111111112222222",
  "amount": 1050.75,
  "description": "Paga questo avviso",
  "expiryDate": "2025-12-31",
  "payerName": "Leonardo Qbicle",
  "payerId": "QBICLE31R41A110G",
  "payeeName": "Comune di Roma",
  "payeeId": "77777777777",
  "subject": "TARI 2025",
  "savingDateTime": "2025-06-06T08:40:16.781Z",
  "serviceProviderDebtor": "FAKESP01",
  "iban": "IT60X0542811101000000123456",
  "payTrxRef": "ABC/124",
  "status": "ACCEPTED",
  "serviceProviderCreditor": "PA123456789"
}</set-body>
        </return-response>
      </when>
      <!-- Case 3: Sent scenario (default) - empty body, presuppone callback successiva -->
      <otherwise>
        <return-response>
          <set-status code="201" reason="Created"/>
          <set-header name="Content-Type" exists-action="override">
            <value>application/json</value>
          </set-header>
          <set-header name="Location" exists-action="override">
            <value>https://domain.com/rtps/3fa85f64-5717-4562-b3fc-2c963f66afa7</value>
          </set-header>
        </return-response>
      </otherwise>
    </choose>
  </inbound>
  <backend>
    <base/>
  </backend>
  <outbound>
    <base/>
  </outbound>
  <on-error>
    <base/>
  </on-error>
</policies>
